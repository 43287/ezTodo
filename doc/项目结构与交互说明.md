# 项目结构与交互说明

- 技术栈：`Next.js 16`、`React 19`、`Tailwind v4`、`Tauri 2 (Rust)`、`TypeScript`
- 形态：前端静态导出，后端为本地命令层；通过 `invoke` 进行前后端交互

## 目录结构

- 根目录 `ezTodo`
  - `src-tauri/`：Rust 后端与 Tauri 配置
    - `src/lib.rs`：命令注册与状态初始化（`src-tauri/src/lib.rs:16-28`）
    - `src/api/todo.rs`：任务命令与持久化（`src-tauri/src/api/todo.rs:52-95`）
    - `src/api/plan.rs`：计划命令与持久化（`src-tauri/src/api/plan.rs:112-164`）
    - `tauri.conf.json`：构建绑定与资源目录（`src-tauri/tauri.conf.json:7-11`）
  - `otherP/`：Next 前端
    - `lib/tauriClient.ts`：后端命令封装（Todo/Plan）
    - `context/todo-context.tsx`：前端状态与交互逻辑
    - `next.config.mjs`：静态导出（`otherP/next.config.mjs:9`）

## 构建与运行

- 开发：
  - 前端：`pnpm -C otherP dev`（`src-tauri/tauri.conf.json:7`）
  - Tauri：`pnpm tauri dev`，载入 `http://localhost:3001`（`src-tauri/tauri.conf.json:8`）
- 打包：
  - 前端构建与导出至 `otherP/out`（`otherP/next.config.mjs:9`）
  - Tauri 读取 `frontendDist: ../otherP/out` 进行打包（`src-tauri/tauri.conf.json:10-11`）

## 数据模型

- Todo（与前端一致，camelCase）：
  - `id`、`title`、`description`、`completed`、`important`、`dueDate`、`createdAt`、`completedAt?`、`priority`、`category`、`fromPlanId?`
- Plan（与前端一致，camelCase）：
  - `id`、`title`、`description`、`repeatCycle`、`planDays`、`startTime`、`endTime`、`repeatCount?`、`currentCount`、`cycleTargetCount`、`totalCompletedCount`、`lastResetDate`、`createdAt`、`category`、`active`、`important`

## 后端命令 API

- Todo：
  - `todo_create(input)` → `Todo`
  - `todo_list()` → `Todo[]`
  - `todo_get(id)` → `Todo`
  - `todo_update(todo)` → `Todo`
  - `todo_delete(id)` → `boolean`
- Plan：
  - `plan_create(input)` → `Plan`
  - `plan_list()` → `Plan[]`
  - `plan_update(plan)` → `Plan`
  - `plan_delete(id)` → `boolean`
  - `plan_refresh()` → `Plan[]`（按周期重置 `currentCount`）
- History：
  - `history_list()` → 根据 Todo 的 `createdAt` 与 `completedAt` 生成历史记录（仅 `todo_created`、`todo_completed`）
- 错误码：`BAD_INPUT`、`NOT_FOUND`、`IO_ERROR`、`LOCK_ERROR`

## 前后端交互流程

- 初始化加载：
  - 并发拉取 `todoList` 与 `planList`，随后调用 `planRefresh` 更新本周期计数（`otherP/context/todo-context.tsx`）
- 用户操作映射：
  - 添加任务：`todoCreate` → 列表更新 + 历史记录
  - 更新任务（完成/重要）：`todoUpdate` → 状态更新 + 计划计数联动
  - 删除任务：`todoDelete`
  - 添加计划：`planCreate` → 列表更新 + 历史记录
  - 更新计划（激活/重要）：`planUpdate`
  - 删除计划：`planDelete`（同时清理关联任务）
  - 刷新计划：`planRefresh`（自动或手动触发）

## 前端调用示例

- `otherP/lib/tauriClient.ts` 封装：

```
import { invoke } from "@tauri-apps/api/core"

export async function todoCreate(input) {
    return await invoke("todo_create", { input })
}
export async function todoList() { return await invoke("todo_list") }
export async function planCreate(input) { return await invoke("plan_create", { input }) }
export async function planList() { return await invoke("plan_list") }
export async function planRefresh() { return await invoke("plan_refresh") }
export async function historyList() { return await invoke("history_list") }
```

## 用户操作指南（输入/输出）

- 输入（表单）：
  - 任务：标题（必填）、描述、重要、截止日期、优先级、分类
  - 计划：标题（必填）、描述、周期（daily/weekly/monthly）、计划日、时间段、目标次数、分类、激活、重要
- 输出（界面）：
  - 列表区分进行中/暂停/已完成/本周期已完成，显示计数与状态标记
  - 历史记录仅包含 Todo 的创建与完成（来源于后端的 `history_list`）

## 复杂度与优化建议

- 命令复杂度：
  - Todo：create O(1)、list O(n)、get/update/delete O(n)
  - Plan：list/refresh O(n)、update/delete O(n)
- 优化建议：
  - 引入 id→位置索引（HashMap），将查找相关操作降至 O(1)
  - 批量写入与事务化，减少磁盘 I/O；写入采用临时文件+重命名避免部分写入
